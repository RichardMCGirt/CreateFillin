<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Fillin</title>
  <link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="cart.css" />

  <link rel="icon" type="image/x-icon" href="/favicon.ico" />

</head>
<body>

  <main>
    <header class="cart-header">
      <div class="cart-actions" role="toolbar" aria-label="Cart actions">
        <a href="index.html" class="btn btn--ghost btn--back btn--icon-only" aria-label="Continue browsing">
          
          <span class="btn__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" focusable="false" aria-hidden="true">
              <path d="M15 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="btn__text">Continue Browsing</span>
        </a>
        <h1 class="h2">Your Cart</h1>
        <button id="clearCart" class="btn danger" aria-label="Clear all items">Fillin</button>
      </div>
    </header>

    <section id="fillin-section" class="card" aria-labelledby="fillinTitle">
      <div id="airtableBanner">
        <strong>Missing Airtable API Key.</strong> In your browser console run:
        <code>localStorage.setItem('AIRTABLE_API_KEY','YOUR_AIRTABLE_PAT_HERE')</code>
      </div>
      <header class="stack" style="margin-bottom: 8px;">
        <strong id="fillinTitle">Fill-In Request Details</strong>
      </header>

   

        <div class="field">
          <label class="field-label" for="branchSelect">Branch</label>
          <select id="branchSelect"><option value="">—</option></select>
        </div>
           <div class="grid" role="group" aria-label="Fill-In Request Fields">
        <div class="field">
          <label class="field-label" for="customerSelect">Customer</label>
          <select id="customerSelect"><option value="">—</option></select>
        </div>

        <div class="field">
          <label class="field-label" for="fieldManagerSelect">Field Manager</label>
          <select id="fieldManagerSelect"><option value="">—</option></select>
        </div>

    <div class="field">
  <label class="field-label" for="neededBySelect">Needed By</label>
  <select id="neededBySelect">
    <option value="" selected>— Select —</option>
    <option value="ASAP">ASAP</option>
    <option value="Tomorrow">Tomorrow</option>
  </select>
</div>


        <div class="field">
          <label class="field-label" for="jobName">Job Name</label>
          <input id="jobName" type="text" placeholder="Job Name" />
        </div>

        <div class="field">
          <label class="field-label" for="planName">Plan Name</label>
          <input id="planName" type="text" placeholder="Plan Name" />
        </div>

        <div class="field">
          <label class="field-label" for="elevation">Elevation</label>
          <input id="elevation" type="text" placeholder="Elevation" />
        </div>

       <div class="field">
  <label class="field-label" for="reasonSelect">Reason For Fill In</label>
  <select id="reasonSelect">
    <option value="" selected>— Select —</option>
    <option value="Takeoff Incorrect">Takeoff Incorrect</option>
    <option value="Theft">Theft</option>
    <option value="Subcontractor Installed Incorrectly">Subcontractor Installed Incorrectly</option>
    <option value="Missing Options">Missing Options</option>
    <option value="Ordered Incorrectly">Ordered Incorrectly</option>
    <option value="Scope Not Followed">Scope Not Followed</option>
    <option value="Damaged">Damaged</option>
    <option value="Scope Has Changed">Scope Has Changed</option>
    <option value="Borrowed Material For Another Job">Borrowed Material For Another Job</option>
    <option value="Warranty Item">Warranty Item</option>
    <option value="Other">Other</option>
  </select>
</div>


        <div class="field">
          <label class="field-label" for="pleaseDescribe">Please Describe</label>
          <textarea id="pleaseDescribe" placeholder="Describe the situation"></textarea>
        </div>
      </div>

      <div class="right">
        <span id="airtableStatus" class="pill" aria-live="polite" aria-atomic="true">Idle</span>
        <button id="saveAirtable" class="btn primary">Save to Airtable</button>
      </div>
    </section>

    <section id="cart-section" class="card" aria-labelledby="cartTitle">
      <header class="stack" style="margin-bottom: 8px;">
        <strong id="cartTitle">Selected SKUs</strong>
      </header>

      <table id="cart-table">
        <thead>
          <tr>
            <th>Vendor</th>
            <th>SKU</th>
            <th>Description</th>
            <th>Qty</th>
            <th>Unit (Sell)</th>
            <th>Line Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

   

      <div class="sep"></div>

      <div id="globalMarginWrap">
        <div class="field">
          <label class="field-label" for="globalMarginPct">Material Margin (%)</label>
          <input id="globalMarginPct" type="number" min="0" step="1" value="30" />
        </div>
      </div>

      <div id="totals" aria-live="polite" aria-atomic="true">
        <div class="label grand">Grand Total:</div><div class="value grand" id="grandTotal">$0.00</div>
      </div>

    
    </section>
  </main>

  <div id="toast" role="status" aria-live="polite" aria-atomic="true" style="display:none;">Done</div>

  <script src="airtable.service.js"></script>

<script src="airtable.service.js"></script>
<script src="cart.js"></script>
<script src="patch.js"></script>


<script>
(function(){
  function setNeededByOptions(){
    var el = document.getElementById("neededBySelect");
    if (!el) return;
    while (el.firstChild) el.removeChild(el.firstChild);
    el.appendChild(new Option("— Select —", "", true, false));
    ["ASAP","Tomorrow"].forEach(function(v){
      el.appendChild(new Option(v, v));
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setNeededByOptions);
  } else {
    setNeededByOptions();
  }
})();

(function(){
  function setReasonOptions(){
    var el = document.getElementById("reasonSelect");
    if (!el) return;
    while (el.firstChild) el.removeChild(el.firstChild);
    el.appendChild(new Option("— Select —", "", true, false));
    [
      "Takeoff Incorrect",
      "Theft",
      "Subcontractor Installed Incorrectly",
      "Missing Options",
      "Ordered Incorrectly",
      "Scope Not Followed",
      "Damaged",
      "Scope Has Changed",
      "Borrowed Material For Another Job",
      "Warranty Item",
      "Other"
    ].forEach(function(v){ el.appendChild(new Option(v, v)); });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setReasonOptions);
  } else {
    setReasonOptions();
  }
})();

(function(){
  "use strict";
  var IDS = {
    branch: "branchSelect",
    fm:     "fieldManagerSelect"
  };

  var KEYS = {
    branchId:   "vanir_branch_id",
    branchLbl:  "vanir_branch_label",
    fmId:       "vanir_field_manager_id",
    fmLbl:      "vanir_field_manager_label"
  };

  // --- Tiny utils ---
  function $(id){ return document.getElementById(id); }
  function nonEmpty(s){ return typeof s === "string" && s.trim() !== ""; }
  function trySet(key, val){ try { localStorage.setItem(key, String(val ?? "")); } catch(e){} }
  function tryGet(key){ try { return localStorage.getItem(key) || ""; } catch(e){ return ""; } }

  // Ensure an option exists; if not, append one (for fallback by label/ID)
  function ensureOption(selectEl, value, label){
    if (!selectEl || !nonEmpty(String(value))) return;
    var exists = Array.prototype.some.call(selectEl.options, function(o){ return o.value === String(value); });
    if (!exists) {
      var opt = document.createElement("option");
      opt.value = String(value);
      opt.textContent = nonEmpty(label) ? String(label) : String(value);
      opt.dataset.restored = "true";
      selectEl.appendChild(opt);
    }
    selectEl.value = String(value);
  }

  // Try to select by value (ID) OR by matching label case-insensitively
  function selectByIdOrLabel(selectEl, savedId, savedLabel){
    if (!selectEl) return false;

    // 1) Try by exact value (record ID)
    if (nonEmpty(savedId)) {
      selectEl.value = savedId;
      if (selectEl.value === savedId) return true;
    }

    // 2) Try by label (case-insensitive)
    if (nonEmpty(savedLabel)) {
      var want = savedLabel.trim().toLowerCase();
      for (var i=0; i<selectEl.options.length; i++){
        var o = selectEl.options[i];
        if ((o.textContent || "").trim().toLowerCase() === want) {
          selectEl.value = o.value;
          return true;
        }
      }
      // 3) If still not found, create a fallback option using the label
      ensureOption(selectEl, savedId || savedLabel, savedLabel);
      return true;
    }

    return false;
  }

  // Wait until a select has options (beyond a placeholder) before restoring.
  // Uses MutationObserver + a short timeout guard.
  function whenOptionsReady(selectEl, callback){
    if (!selectEl) return;

    var readyNow = selectEl.options && selectEl.options.length > 1;
    if (readyNow) { callback(); return; }

    var done = false;
    var observer = new MutationObserver(function(){
      if (done) return;
      var ok = selectEl.options && selectEl.options.length > 1;
      if (ok) {
        done = true;
        try { observer.disconnect(); } catch(e){}
        callback();
      }
    });
    try { observer.observe(selectEl, { childList:true, subtree:false }); } catch(e){}

    // Safety: also try again after a short delay in case options are injected programmatically
    setTimeout(function(){
      if (done) return;
      var ok = selectEl.options && selectEl.options.length > 1;
      if (ok) {
        done = true;
        try { observer.disconnect(); } catch(e){}
        callback();
      }
    }, 2000);
  }

  // Save handlers
  function saveBranch(){
    var sel = $(IDS.branch);
    if (!sel) return;
    var val = sel.value || "";
    var lbl = (sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : "") || "";
    trySet(KEYS.branchId,  val);
    trySet(KEYS.branchLbl, lbl);
  }
  function saveFieldManager(){
    var sel = $(IDS.fm);
    if (!sel) return;
    var val = sel.value || "";
    var lbl = (sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : "") || "";
    trySet(KEYS.fmId,  val);
    trySet(KEYS.fmLbl, lbl);
  }

  // Restore routine (runs once options are present)
  function restoreBranch(){
    var sel = $(IDS.branch);
    if (!sel) return;
    var id  = tryGet(KEYS.branchId);
    var lbl = tryGet(KEYS.branchLbl);
    selectByIdOrLabel(sel, id, lbl);
  }
  function restoreFieldManager(){
    var sel = $(IDS.fm);
    if (!sel) return;
    var id  = tryGet(KEYS.fmId);
    var lbl = tryGet(KEYS.fmLbl);
    selectByIdOrLabel(sel, id, lbl);
  }

  // Wire up on DOM ready
  function init(){
    var branchSel = $(IDS.branch);
    var fmSel     = $(IDS.fm);

    // Restore AFTER options have loaded
    if (branchSel) whenOptionsReady(branchSel, restoreBranch);
    if (fmSel)     whenOptionsReady(fmSel,     restoreFieldManager);

    // Save on change
    if (branchSel) branchSel.addEventListener("change", saveBranch, { passive:true });
    if (fmSel)     fmSel.addEventListener("change",     saveFieldManager, { passive:true });

    // Also do a last-chance restore a bit later (covers late async fills)
    setTimeout(function(){
      try { restoreBranch(); } catch(e){}
      try { restoreFieldManager(); } catch(e){}
    }, 3000);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();

</script>

</body>
</html>
